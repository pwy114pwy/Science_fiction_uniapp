"use strict";const t=require("../../../../common/vendor.js"),e=require("./canvas.js"),s=require("./utils.js"),i={name:"lime-echart",props:{type:{type:String,default:"2d"},customStyle:String,isDisableScroll:Boolean,isClickable:{type:Boolean,default:!0},enableHover:Boolean,beforeDelay:{type:Number,default:30},landscape:Boolean},data:()=>({use2dCanvas:!0,ariaLabel:"图表",width:null,height:null,nodeWidth:null,nodeHeight:null,config:{},inited:!1,finished:!1,file:"",platform:"",isPC:!1,isDown:!1,isOffscreenCanvas:!1,offscreenWidth:0,offscreenHeight:0}),computed:{rootStyle(){if(this.landscape)return"transform: translate(-50%,-50%) rotate(90deg); top:50%; left:50%;"},canvasId(){return`lime-echart${this._&&this._.uid||this._uid}`},offscreenCanvasId(){return`${this.canvasId}_offscreen`},offscreenStyle(){return`width:${this.offscreenWidth}px;height: ${this.offscreenHeight}px; position: fixed; left: 99999px; background: red`},canvasStyle(){return this.rootStyle+(this.width&&this.height?"width:"+this.width+"px;height:"+this.height+"px":"")}},beforeUnmount(){this.clear(),this.dispose()},created(){const{platform:t}=s.getDeviceInfo();this.isPC=/windows/i.test(t),this.use2dCanvas="2d"===this.type&&s.canIUseCanvas2d()},mounted(){this.$nextTick((()=>{this.$emit("finished")}))},methods:{setChart(t){this.chart?"function"==typeof t&&this.chart&&t(this.chart):console.warn("组件还未初始化，请先使用 init")},setOption(){this.chart&&this.chart.setOption?this.chart.setOption(...arguments):console.warn("组件还未初始化，请先使用 init")},showLoading(){this.chart&&this.chart.showLoading(...arguments)},hideLoading(){this.chart&&this.chart.hideLoading()},clear(){this.chart&&this.chart.clear()},dispose(){this.chart&&this.chart.dispose()},resize(e){e&&e.width&&e.height?(this.height=e.height,this.width=e.width,this.chart&&this.chart.resize(e)):this.$nextTick((()=>{t.index.createSelectorQuery().in(this).select(".lime-echart").boundingClientRect().exec((t=>{if(t){let{width:e,height:s}=t[0];this.width=e=e||300,this.height=s=s||300,this.chart.resize({width:e,height:s})}}))}))},canvasToTempFilePath(e={}){const{use2dCanvas:s,canvasId:i}=this;return new Promise(((h,a)=>{const o=Object.assign({canvasId:i,success:h,fail:a},e);s&&(delete o.canvasId,o.canvas=this.canvasNode),t.index.canvasToTempFilePath(o,this)}))},async init(t,...i){if(i&&0==i.length&&!t)return void console.error("缺少参数：init(echarts, theme?:string, opts?: object, callback?: function)");let h,a=null,o={};Array.from(arguments).forEach((t=>{"function"==typeof t&&(h=t),["string"].includes(typeof t)&&(a=t),"object"==typeof t&&(o=t)})),this.beforeDelay&&await s.sleep(this.beforeDelay);let n=await this.getContext();e.setCanvasCreator(t,n);try{if(this.chart=t.init(n.canvas,a,Object.assign({},n,o)),"function"!=typeof h)return this.chart;h(this.chart)}catch(c){return console.error(c.messges),null}},getContext(){return s.getRect(`#${this.canvasId}`,{context:this,type:this.use2dCanvas?"fields":"boundingClientRect"}).then((i=>{if(i){let h,a=s.devicePixelRatio,{width:o,height:n,node:c}=i;if(this.width=o=o||300,this.height=n=n||300,c){const t=c.getContext("2d");h=new e.Canvas(t,this,!0,c),this.canvasNode=c}else{a=this.isPC?s.devicePixelRatio:1,this.rect=i,this.nodeWidth=o*a,this.nodeHeight=n*a;const c=t.index.createCanvasContext(this.canvasId,this);h=new e.Canvas(c,this,!1)}return{canvas:h,width:o,height:n,devicePixelRatio:a,node:c}}return{}}))},getRelative(t,e){let{clientX:s,clientY:i}=t;return s&&i||!e||!e[0]||(s=e[0].clientX,i=e[0].clientY),{x:s-this.rect.left,y:i-this.rect.top,wheelDelta:t.wheelDelta||0}},getTouch(t,e){const{x:s}=e&&e[0]||{},i=s?e[0]:this.getRelative(t,e);return this.landscape&&([i.x,i.y]=[i.y,this.height-i.x]),i},touchStart(t){this.isDown=!0;const i=()=>{const i=s.convertTouchesToArray(t.touches);if(this.chart){const h=this.getTouch(t,i);this.startX=h.x,this.startY=h.y,this.startT=new Date;const a=this.chart.getZr().handler;e.dispatch.call(a,"mousedown",h),e.dispatch.call(a,"mousemove",h),a.processGesture(s.wrapTouch(t),"start"),clearTimeout(this.endTimer)}};this.isPC?s.getRect(`#${this.canvasId}`,{context:this}).then((t=>{this.rect=t,i()})):i()},touchMove(t){this.isPC&&this.enableHover&&!this.isDown&&(this.isDown=!0);const i=s.convertTouchesToArray(t.touches);if(this.chart&&this.isDown){const h=this.chart.getZr().handler;e.dispatch.call(h,"mousemove",this.getTouch(t,i)),h.processGesture(s.wrapTouch(t),"change")}},touchEnd(t){if(this.isDown=!1,this.chart){const i=s.convertTouchesToArray(t.changedTouches),{x:h}=i&&i[0]||{},a=(h?i[0]:this.getRelative(t,i))||{};this.landscape&&([a.x,a.y]=[a.y,this.height-a.x]);const o=this.chart.getZr().handler,n=Math.abs(a.x-this.startX)<10&&new Date-this.startT<200;e.dispatch.call(o,"mouseup",a),o.processGesture(s.wrapTouch(t),"end"),n?e.dispatch.call(o,"click",a):this.endTimer=setTimeout((()=>{e.dispatch.call(o,"mousemove",{x:999999999,y:999999999}),e.dispatch.call(o,"mouseup",{x:999999999,y:999999999})}),50)}}}};const h=t._export_sfc(i,[["render",function(e,s,i,h,a,o){return t.e({a:o.canvasId},o.canvasId?t.e({b:a.use2dCanvas},a.use2dCanvas?{c:o.canvasId,d:t.s(o.canvasStyle),e:i.isDisableScroll,f:t.o(((...t)=>o.touchStart&&o.touchStart(...t))),g:t.o(((...t)=>o.touchMove&&o.touchMove(...t))),h:t.o(((...t)=>o.touchEnd&&o.touchEnd(...t)))}:{i:a.nodeWidth,j:a.nodeHeight,k:t.s(o.canvasStyle),l:o.canvasId,m:o.canvasId,n:i.isDisableScroll,o:t.o(((...t)=>o.touchStart&&o.touchStart(...t))),p:t.o(((...t)=>o.touchMove&&o.touchMove(...t))),q:t.o(((...t)=>o.touchEnd&&o.touchEnd(...t)))},{r:a.isPC},a.isPC?{s:t.o(((...t)=>o.touchStart&&o.touchStart(...t))),t:t.o(((...t)=>o.touchMove&&o.touchMove(...t))),v:t.o(((...t)=>o.touchEnd&&o.touchEnd(...t))),w:t.o(((...t)=>o.touchStart&&o.touchStart(...t))),x:t.o(((...t)=>o.touchMove&&o.touchMove(...t))),y:t.o(((...t)=>o.touchEnd&&o.touchEnd(...t)))}:{},{z:a.isOffscreenCanvas},a.isOffscreenCanvas?{A:t.s(o.offscreenStyle),B:o.offscreenCanvasId}:{},{C:t.s(i.customStyle),D:a.ariaLabel}):{})}]]);wx.createComponent(h);
