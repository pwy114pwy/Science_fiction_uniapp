"use strict";const e=require("../../common/vendor.js"),o=require("../../api.js");if(!Array){(e.resolveComponent("uni-rate")+e.resolveComponent("uni-icons"))()}Math||((()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js"))();const t={__name:"detail",setup(t){let n=e.ref(!1),r=e.ref(!1),a=e.ref(!1),s=e.ref({}),u=e.ref(""),i=e.ref(""),c=e.index.getStorageSync("NowBook"),l={};e.index.getStorageSync("userInfo")?(a.value=!0,l=JSON.parse(e.index.getStorageSync("userInfo"))):(a.value=!1,l={});let m=e.ref(!1);function _(){e.index.setStorageSync("NowIllustrated",c),e.index.navigateTo({url:`/pages/Illustrated_detail/Illustrated_detail?id=${c.Book_ID}`})}async function d(t){try{const n=await e.index.request({url:o.Get_DetailBook,method:"POST",data:{bookId:t}});s.value=n.data.data,u.value=n.data.data.Book_Introduce.slice(0,90),i.value=n.data.data.Author_Introduction.slice(0,60),console.log(n.data.data)}catch(n){console.error("Error fetching book details:",n)}}function f(){a.value?(m.value?async function(){try{await e.index.request({url:o.UNCOLLECT_BOOK,method:"POST",data:{User_Name:l.username,Book_ID:c.Book_ID,Book_Name:c.Book_Name,Collect_Time:new Date}})}catch(t){console.error("Error fetching book collect:",t)}}():async function(){try{await e.index.request({url:o.Collect_Book,method:"POST",data:{User_Name:l.username,Book_ID:c.Book_ID,Book_Name:c.Book_Name,Collect_Time:g(),Img_Url:c.Img_Url}})}catch(t){console.error("Error fetching book collect:",t)}}(),m.value=!m.value):e.index.showModal({title:"提示",content:"您尚未登录，是否前往登录页面？",showCancel:!0,cancelText:"取消",confirmText:"确定",success:function(o){o.confirm&&e.index.reLaunch({url:"/pages/login/login"})}})}let g=()=>{let e=new Date;return e.getFullYear()+"年"+(e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1)+"月"+(e.getDate()<10?"0"+e.getDate():e.getDate())+"日"+(e.getHours()<10?"0"+e.getHours():e.getHours())+":"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+":"+(e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds())};e.onShareAppMessage((e=>{let o={title:s.value.Book_Name,path:`/pages/detail/detail?id=${JSON.stringify(s.value.Book_Id)}`,imageUrl:s.value.Img_Url,success:function(e){"shareAppMessage:ok"===e.errMsg&&console.log("分享成功")},fail:function(e){"shareAppMessage:fail cancel"===e.errMsg?console.log("用户取消分享"):"shareAppMessage:fail"===e.errMsg&&console.error("分享失败:",e.errMsg)},complete:function(){console.log("分享结束")}};if("button"===e.from){const t=e.target.dataset;console.log(t.name),o.path=`/pages/btnname/btnname?btn_name=${t.name}`}return o}));let h=e.ref({Content:"",Comment_User_NickName:l.nickname||"匿名用户",Comment_Time:""});async function k(){if(a.value){""==h.value.Content&&e.index.showToast({title:"不能为空",icon:"error",duration:2e3}),h.value.Comment_Time=g();try{const t=await e.index.request({url:o.AddBook_Comment,method:"POST",data:{Comment_User_Name:l.username,Comment_User_NickName:h.value.Comment_User_NickName,Book_ID:c.Book_ID,Book_Name:c.Book_Name,Comment_Content:h.value.Content,Comment_Time:h.value.Comment_Time}});h.value.Content="",d(c.Book_ID),console.log(t),200==t.statusCode&&e.index.showToast({title:"评论成功",icon:"success",duration:2e3})}catch(t){console.error("Error submitting comment:",t),e.index.showToast({title:"评论失败，请重试",icon:"none",duration:2e3})}}else e.index.showModal({title:"提示",content:"您尚未登录，是否前往登录页面？",showCancel:!0,cancelText:"取消",confirmText:"确定",success:function(o){o.confirm&&e.index.reLaunch({url:"/pages/login/login"})}})}function C(t){e.index.showModal({title:"提示",content:"您确定要删除吗？",showCancel:!0,cancelText:"取消",confirmText:"确定",success:function(n){n.confirm&&async function(t){console.log(t);try{200==(await e.index.request({url:o.DeleteBook_Comment,method:"POST",data:{Comment_User_Name:l.username,Book_Comment_ID:t}})).statusCode&&e.index.showToast({title:"删除成功",icon:"success",duration:2e3}),d(c.Book_ID)}catch(n){}}(t)}})}return e.onLoad((t=>{const n=JSON.parse(t.id);!async function(){try{const t=await e.index.request({url:o.GET_USER_COLLECT_BOOK,method:"POST",data:{User_Name:l.username}});m.value=t.data.some((e=>e.Book_ID==c.Book_ID))}catch(t){console.error("Error fetching book collect:",t)}}(),d(n),async function(){try{await e.index.request({url:o.Insert_BrowseHistory,method:"POST",data:{User_Name:l.username,Book_ID:c.Book_ID,Book_Name:c.Book_Name,Browse_Time:g(),Img_Url:c.Img_Url}})}catch(t){console.error("Error fetching book collect:",t)}}()})),(o,t)=>e.e({a:e.unref(s).Img_Url,b:e.t(e.unref(s).Book_Name),c:e.t(e.unref(s).Author),d:e.t(e.unref(s).Topic),e:e.o((o=>e.unref(s).Rating=o)),f:e.p({touchable:!1,modelValue:e.unref(s).Rating}),g:e.t(e.unref(m)?"已收藏":"收藏"),h:e.o(f),i:e.unref(m)?1:"",j:e.o(_),k:e.p({type:"images-filled",size:"50"}),l:!e.unref(n)},e.unref(n)?{q:e.t(e.unref(s).Book_Introduce),r:e.t(e.unref(n)?"收起":"展开"),s:e.o((o=>e.isRef(n)?n.value=!e.unref(n):n=!e.unref(n)))}:{m:e.t(e.unref(u)),n:e.t(e.unref(n)?"收起":"展开"),o:e.o((o=>e.isRef(n)?n.value=!e.unref(n):n=!e.unref(n))),p:e.unref(n)?1:""},{t:!e.unref(r)},e.unref(r)?{z:e.t(e.unref(s).Author_Introduction),A:e.t(e.unref(r)?"收起":"展开"),B:e.o((o=>e.isRef(r)?r.value=!e.unref(r):r=!e.unref(r)))}:{v:e.t(e.unref(i)),w:e.t(e.unref(r)?"收起":"展开"),x:e.o((o=>e.isRef(r)?r.value=!e.unref(r):r=!e.unref(r))),y:e.unref(r)?1:""},{C:e.f(e.unref(s).Book_Comment,((o,t,n)=>e.e({a:e.t(o.Comment_User_NickName),b:e.t(o.Comment_Time),c:o.Comment_User_Name==e.unref(l).username},o.Comment_User_Name==e.unref(l).username?{d:e.o((e=>C(o.Book_Comment_ID)),t),e:"e9432e2d-2-"+n,f:e.p({type:"trash",size:"15"})}:{},{g:e.t(o.Comment_Content),h:t}))),D:e.unref(h).Content,E:e.o((o=>e.unref(h).Content=o.detail.value)),F:e.o(k)})}},n=e._export_sfc(t,[["__scopeId","data-v-e9432e2d"]]);t.__runtimeHooks=2,wx.createPage(n);
