"use strict";const e=require("../../common/vendor.js"),_=require("../../api.js");if(!Array){const h=e.resolveComponent("uni-rate"),a=e.resolveComponent("uni-icons");(h+a)()}const M=()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js",O=()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js";Math||(M+O)();const v={__name:"detail",setup(h){let a=e.ref(!1),r=e.ref(!1),d=e.ref(!1),i=e.ref({}),k=e.ref(""),C=e.ref(""),s=e.index.getStorageSync("NowBook"),u={};e.index.getStorageSync("userInfo")?(d.value=!0,u=JSON.parse(e.index.getStorageSync("userInfo"))):(d.value=!1,u={});let c=e.ref(!1);function B(){e.index.setStorageSync("NowIllustrated",s),e.index.navigateTo({url:`/pages/Illustrated_detail/Illustrated_detail?id=${s.Book_ID}`})}async function f(t){try{const n=await e.index.request({url:_.Get_DetailBook,method:"POST",data:{bookId:t}});i.value=n.data.data,k.value=n.data.data.Book_Introduce.slice(0,90),C.value=n.data.data.Author_Introduction.slice(0,60),e.index.__f__("log","at pages/detail/detail.vue:142",n.data.data)}catch(n){e.index.__f__("error","at pages/detail/detail.vue:144","Error fetching book details:",n)}}async function I(){try{const t=await e.index.request({url:_.Collect_Book,method:"POST",data:{User_Name:u.username,Book_ID:s.Book_ID,Book_Name:s.Book_Name,Collect_Time:g(),Img_Url:s.Img_Url}})}catch(t){e.index.__f__("error","at pages/detail/detail.vue:162","Error fetching book collect:",t)}}async function N(){try{const t=await e.index.request({url:_.UNCOLLECT_BOOK,method:"POST",data:{User_Name:u.username,Book_ID:s.Book_ID,Book_Name:s.Book_Name,Collect_Time:new Date}})}catch(t){e.index.__f__("error","at pages/detail/detail.vue:180","Error fetching book collect:",t)}}async function y(){try{const t=await e.index.request({url:_.GET_USER_COLLECT_BOOK,method:"POST",data:{User_Name:u.username}});c.value=t.data.some(n=>n.Book_ID==s.Book_ID)}catch(t){e.index.__f__("error","at pages/detail/detail.vue:196","Error fetching book collect:",t)}}function T(){if(!d.value){e.index.showModal({title:"提示",content:"您尚未登录，是否前往登录页面？",showCancel:!0,cancelText:"取消",confirmText:"确定",success:function(t){t.confirm&&e.index.reLaunch({url:"/pages/login/login"})}});return}c.value?N():I(),c.value=!c.value}async function D(){try{const t=await e.index.request({url:_.Insert_BrowseHistory,method:"POST",data:{User_Name:u.username,Book_ID:s.Book_ID,Book_Name:s.Book_Name,Browse_Time:g(),Img_Url:s.Img_Url}})}catch(t){e.index.__f__("error","at pages/detail/detail.vue:244","Error fetching book collect:",t)}}let g=()=>{let t=new Date,n=t.getFullYear(),o=t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1,m=t.getDate()<10?"0"+t.getDate():t.getDate(),p=t.getHours()<10?"0"+t.getHours():t.getHours(),x=t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes(),b=t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds();return n+"年"+o+"月"+m+"日"+p+":"+x+":"+b};e.onShareAppMessage(t=>{let n={title:i.value.Book_Name,path:`/pages/detail/detail?id=${JSON.stringify(i.value.Book_Id)}`,imageUrl:i.value.Img_Url,success:function(o){o.errMsg==="shareAppMessage:ok"&&e.index.__f__("log","at pages/detail/detail.vue:272","分享成功")},fail:function(o){o.errMsg==="shareAppMessage:fail cancel"?e.index.__f__("log","at pages/detail/detail.vue:277","用户取消分享"):o.errMsg==="shareAppMessage:fail"&&e.index.__f__("error","at pages/detail/detail.vue:279","分享失败:",o.errMsg)},complete:function(){e.index.__f__("log","at pages/detail/detail.vue:283","分享结束")}};if(t.from==="button"){const o=t.target.dataset;e.index.__f__("log","at pages/detail/detail.vue:289",o.name),n.path=`/pages/btnname/btnname?btn_name=${o.name}`}return n});let l=e.ref({Content:"",Comment_User_NickName:u.nickname||"匿名用户",Comment_Time:""});async function S(){if(!d.value){e.index.showModal({title:"提示",content:"您尚未登录，是否前往登录页面？",showCancel:!0,cancelText:"取消",confirmText:"确定",success:function(t){t.confirm&&e.index.reLaunch({url:"/pages/login/login"})}});return}l.value.Content==""&&e.index.showToast({title:"不能为空",icon:"error",duration:2e3}),l.value.Comment_Time=g();try{const t=await e.index.request({url:_.AddBook_Comment,method:"POST",data:{Comment_User_Name:u.username,Comment_User_NickName:l.value.Comment_User_NickName,Book_ID:s.Book_ID,Book_Name:s.Book_Name,Comment_Content:l.value.Content,Comment_Time:l.value.Comment_Time}});l.value.Content="",f(s.Book_ID),e.index.__f__("log","at pages/detail/detail.vue:350",t),t.statusCode==200&&e.index.showToast({title:"评论成功",icon:"success",duration:2e3})}catch(t){e.index.__f__("error","at pages/detail/detail.vue:359","Error submitting comment:",t),e.index.showToast({title:"评论失败，请重试",icon:"none",duration:2e3})}}function w(t){e.index.showModal({title:"提示",content:"您确定要删除吗？",showCancel:!0,cancelText:"取消",confirmText:"确定",success:function(n){n.confirm&&U(t)}})}async function U(t){e.index.__f__("log","at pages/detail/detail.vue:386",t);try{(await e.index.request({url:_.DeleteBook_Comment,method:"POST",data:{Comment_User_Name:u.username,Book_Comment_ID:t}})).statusCode==200&&e.index.showToast({title:"删除成功",icon:"success",duration:2e3}),f(s.Book_ID)}catch{}}return e.onLoad(t=>{const n=JSON.parse(t.id);y(),f(n),D()}),(t,n)=>e.e({a:e.unref(i).Img_Url,b:e.t(e.unref(i).Book_Name),c:e.t(e.unref(i).Author),d:e.t(e.unref(i).Topic),e:e.o(o=>e.unref(i).Rating=o),f:e.p({touchable:!1,modelValue:e.unref(i).Rating}),g:e.t(e.unref(c)?"已收藏":"收藏"),h:e.o(T),i:e.unref(c)?1:"",j:e.o(B),k:e.p({type:"images-filled",size:"50"}),l:!e.unref(a)},e.unref(a)?{q:e.t(e.unref(i).Book_Introduce),r:e.t(e.unref(a)?"收起":"展开"),s:e.o(o=>e.isRef(a)?a.value=!e.unref(a):a=!e.unref(a))}:{m:e.t(e.unref(k)),n:e.t(e.unref(a)?"收起":"展开"),o:e.o(o=>e.isRef(a)?a.value=!e.unref(a):a=!e.unref(a)),p:e.unref(a)?1:""},{t:!e.unref(r)},e.unref(r)?{z:e.t(e.unref(i).Author_Introduction),A:e.t(e.unref(r)?"收起":"展开"),B:e.o(o=>e.isRef(r)?r.value=!e.unref(r):r=!e.unref(r))}:{v:e.t(e.unref(C)),w:e.t(e.unref(r)?"收起":"展开"),x:e.o(o=>e.isRef(r)?r.value=!e.unref(r):r=!e.unref(r)),y:e.unref(r)?1:""},{C:e.f(e.unref(i).Book_Comment,(o,m,p)=>e.e({a:e.t(o.Comment_User_NickName),b:e.t(o.Comment_Time),c:o.Comment_User_Name==e.unref(u).username},o.Comment_User_Name==e.unref(u).username?{d:e.o(x=>w(o.Book_Comment_ID),m),e:"eca06f3c-2-"+p,f:e.p({type:"trash",size:"15"})}:{},{g:e.t(o.Comment_Content),h:m})),D:e.unref(l).Content,E:e.o(o=>e.unref(l).Content=o.detail.value),F:e.o(S)})}},E=e._export_sfc(v,[["__scopeId","data-v-eca06f3c"]]);v.__runtimeHooks=2;wx.createPage(E);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/detail/detail.js.map
